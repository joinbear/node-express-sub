angular.module("webapp").factory("Trade",["$resource",function($resource){return $resource("http://10.63.0.86:3000/trade.json",{contractNum:"@contractNum",contractType:"@contractType"},{})}]).factory("TradeList",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_proc/tmTfProc.do?method=wxAppReadProcList&argDateType=contractDate&argBeginDate=1000-01-01&argEndDate=3000-01-01&argProcStatus=IS_PROCESSING",{argKeyChars:"@argKeyChars"},{})}]).factory("TradeSubmit",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_transac/tmTfTransac.do?method=wxAppUpdateAsync",{fdId:"@fdId",data:"@data"},{sendData:{method:"post"}})}]).factory("TradeStep",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_remark/tmTfRemark.do?method=wxAppAdd&forWhat=FOR_NODE",{nodeId:"@nodeId",isRunToBusi:"@isRunToBusi"},{})}]).factory("UpdateFinance",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_proc/tmTfProc.do?method=updateChildEndFinance",{financeId:"@financeId"},{})}]).factory("AddRemark",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_remark/tmTfRemark.do?method=wxAppSave",{data:"@data"},{})}]).factory("SaveLoan",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_transac/tmTfTransac.do?method=wxAppUpdateAsyncByEvaluateNodeBusiData",{data:"@data"},{})}]).factory("CheckStep",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_transac/tmTfTransac.do?method=sendForwardCheck",{nodeId:"@nodeId"},{})}]).factory("GoNext",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_transac/tmTfTransac.do?method=sendForward",{nodeId:"@nodeId"},{})}]).factory("SubmitNetsignedNo",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_transac/tmTfTransac.do?method=updateNetsignedNo",{contractId:"@contractId",netsignedNo:"@netsignedNo"},{})}]).factory("TradeDetail",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_proc/tmTfProc.do?method=wxAppReadMainData",{contractId:"@contractId"},{})}]).factory("CommentInfo",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_remark/tmTfRemark.do?method=wxAppAdd&forWhat=FOR_PROC",{procId:"@procId",contractId:"@contractId"},{})}]).factory("SubmitComment",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/ecen/tm/tf/tm_tf_remark/tmTfRemark.do?method=wxAppSave",{data:"@data"},{})}]),angular.module("webapp").factory("TradeService",["MsgTransmitService",function(MsgTransmitService){return{initMsg:function($scope){MsgTransmitService.init($scope,"TradeIndexCtrChange","CtrChangeFromTradeIndexCtr")},sendMsg:function($scope,msg){MsgTransmitService.send($scope,"TradeIndexCtrChange",msg)},receiveMsg:function($scope,callback){MsgTransmitService.receive($scope,"CtrChangeFromTradeIndexCtr",function(event,msg){callback?callback(msg):$scope.tradeData=msg})},navItems:[{navName:"合同信息",navUrl:"ekp.trade.info"},{navName:"过户贷款信息",navUrl:"ekp.trade.loan"},{navName:"办件进度",navUrl:"ekp.trade.progress"}],titleItems:{tradeInfo:"合同信息",tradeLoan:"过户信息",tradeProgress:"交易流程",tradeIndex:"交易点件",tradeList:"合同列表",tradeFail:"没有找到该合同信息!",tradeLoad:"获取数据中...",tradeSubmitFail:"提交数据失败...",tradeSubmit:"提交数据中...",unOperated:"你不能进行该项操作",isSending:"提交数据",sendSuccess:"提交成功！",sendFail:"提交失败！",operateSuccess:"操作成功",operateFail:"操作失败！错误信息："},tradeLoanObj:{ownerInfo:[{name:"netsignedDate",tagName:"网签时间",type:"text"},{name:"netsignedNo",tagName:"网签编号",type:"text"},{name:"netsignedType",tagName:"网签类型",type:"select"},{name:"parking",tagName:"车位数量",type:"text"},{name:"taxesPrice",tagName:"网签报税价",type:"text"},{name:"taxesPrice1",tagName:"税务通过价",type:"text"},{name:"propertyDepart",tagName:"过户房管局",type:"select"}],customInfo:[{name:"cuser",tagName:"主产权人",type:"text"},{name:"caddress",tagName:"户籍地",type:"select"},{name:"cmarriage",tagName:"婚姻状况",type:"select"},{name:"cuser1",tagName:"买方共有人1",type:"text"},{name:"caddress1",tagName:"户籍地",type:"select"},{name:"cmarriage1",tagName:"婚姻状况",type:"select"},{name:"cuser2",tagName:"买方共有人2",type:"text"},{name:"caddress2",tagName:"户籍地",type:"select"},{name:"cmarriage2",tagName:"婚姻状况",type:"select"}],loanInfo:[{name:"creditType",tagName:"贷款类型",type:"select"},{name:"creditBank",tagName:"商贷银行",type:"select"},{name:"creditMoney",tagName:"商贷金额（万",type:"text"},{name:"creditYear",tagName:"贷款年限",type:"text"},{name:"creditBankG",tagName:"公贷银行",type:"select"},{name:"creditMoneyG",tagName:"公贷金额(万)",type:"text"},{name:"creditYear",tagName:"贷款年限",type:"text"},{name:"creditRate",tagName:"贷款利率",type:"select"},{name:"creditCount",tagName:"贷款次数",type:"text"},{name:"estimateCo",tagName:"评估公司",type:"select"},{name:"estimatePrice",tagName:"评估总价(万)",type:"text"},{name:"estimateUnprice",tagName:"评估单价",type:"text"},{name:"salesManager",tagName:"客户经理",type:"text"},{name:"trustFundsFlag",tagName:"是否资金托管",type:"select"}]}}}]).factory("DataService",["TradeDetail","MessageShow","sessionService",function(TradeDetail,MessageShow,sessionService){return{getData:function(callback){var contractId=sessionService.get("contractId")||"";contractId&&TradeDetail.get({contractId:contractId}).$promise.then(function(res){callback(res)},function(err){MessageShow.netErrMsg()})}}}]),angular.module("tradeContrller",["oc.lazyLoad"]).controller("TradeIndexController",["$rootScope","$scope","$state","Trade","sessionService","MsgTransmitService","TradeService","MessageShow","animateService","LocalService","TradeList",function($rootScope,$scope,$state,Trade,sessionService,MsgTransmitService,TradeService,MessageShow,animateService,LocalService,TradeList){var titleItems=TradeService.titleItems,navItems=TradeService.navItems,i=0;$rootScope.indexList.headerContent=titleItems.tradeIndex,$rootScope.indexList.showLogout=!0,$scope.animateClass=animateService.swipeLeft,$scope.swipeLeft=function(){i=i>1?0:i+1,$scope.animateClass=animateService.swipeLeft,animateService.goPage(navItems[i].navUrl)},$scope.swipeRight=function(){i=0==i?2:i-1,$scope.animateClass=animateService.swipeRight,animateService.goPage(navItems[i].navUrl)},$rootScope.indexList.navItem=TradeService.navItems,$scope.tradeObj={hasInfo:!1,tradeNum:""},$scope.tradeData={contractInfo:[],loan:{},progress:[],progressTable:[]},$scope.goList=function(){MessageShow.showMsg(titleItems.tradeLoad),TradeList.get({argKeyChars:$scope.tradeObj.tradeNum}).$promise.then(function(res){res.data.object&&res.data.object.length>0?(MessageShow.hideMsg(),console.log(res.data.object),LocalService.set("listData",JSON.stringify(res.data.object)),$state.go("ekp.trade.list"),$rootScope.indexList.showFooter=!1):MessageShow.toastMsg("没有获取到相关数据")},function(){MessageShow.netErrMsg()})},$scope.tradeObj=angular.fromJson(sessionService.get("tradeObj"))||$scope.tradeObj,$rootScope.indexList.showFooter=$scope.tradeObj.hasInfo,MsgTransmitService.sendHeader($scope,$rootScope.indexList),TradeService.initMsg($scope),TradeService.receiveMsg($scope)}]).controller("TradeListController",["$rootScope","$scope","$state","MsgTransmitService","TradeService","sessionService","TradeDetail","MessageShow","LocalService","DataService",function($rootScope,$scope,$state,MsgTransmitService,TradeService,sessionService,TradeDetail,MessageShow,LocalService,DataService){var titleItems=TradeService.titleItems;$rootScope.indexList.headerContent=titleItems.tradeList,MsgTransmitService.sendHeader($scope,$rootScope.indexList),TradeService.receiveMsg($scope),$scope.getList=function(){$scope.listData=angular.fromJson(LocalService.get("listData"))||[]},$scope.getContractInfo=function(contractId,contractNum){MessageShow.showMsg(titleItems.tradeLoad),sessionService.set("contractId",contractId),DataService.getData(function(res){res.data.object?(MessageShow.hideMsg(),$scope.tradeData=res.data.object,$rootScope.indexList.showFooter=$scope.tradeObj.hasInfo=!0,$scope.tradeObj.tradeNum=contractNum,MsgTransmitService.sendHeader($scope,$rootScope.indexList.showFooter),TradeService.sendMsg($scope,$scope.tradeData),$state.go("ekp.trade.info")):MessageShow.toastMsg(res.data.retMsg)})}}]).controller("TradeInfoController",["$rootScope","$scope","MsgTransmitService","TradeService",function($rootScope,$scope,MsgTransmitService,TradeService){var titleItems=TradeService.titleItems;$rootScope.indexList.headerContent=titleItems.tradeInfo,MsgTransmitService.sendHeader($scope,$rootScope.indexList),TradeService.receiveMsg($scope)}]).controller("TradeLoanController",["$rootScope","$scope","$state","MsgTransmitService","TradeService","TradeSubmit","MessageShow",function($rootScope,$scope,$state,MsgTransmitService,TradeService,TradeSubmit,MessageShow){var titleItems=TradeService.titleItems;$rootScope.indexList.headerContent=titleItems.tradeLoan,MsgTransmitService.sendHeader($scope,$rootScope.indexList),TradeService.receiveMsg($scope),$scope.loanObj=TradeService.tradeLoanObj,$scope.dataObj={},$scope.dataObj.fdId=$scope.tradeData.loan.fdId;var buildData=function(buildData){for(var i in buildData){var data=buildData[i];if("string"==typeof data)$scope.dataObj[i]=data;else for(var j in data)"string"==typeof data[j]&&($scope.dataObj[i]=data[j])}};$scope.submitData=function(fdId){buildData($scope.tradeData.loan.customInfo),buildData($scope.tradeData.loan.loanInfo),buildData($scope.tradeData.loan.ownerInfo),TradeService.sendMsg($scope,$scope.tradeData),TradeService.sendMsg($scope),console.log($scope.dataObj),MessageShow.showMsg(titleItems.tradeSubmit),TradeSubmit.sendData({fdId:fdId,data:$scope.dataObj}).$promise.then(function(res){"0000"==res.status?MessageShow.hideMsg():MessageShow.toastMsg(res.retMsg)},function(err){MessageShow.netErrMsg()})}}]).controller("TradeProgressController",["$rootScope","$scope","$http","$resource","MsgTransmitService","TradeService","TradeStep","MessageShow","UpdateFinance","CheckStep","GoNext","sessionService","AddRemark","HttpHost","SubmitNetsignedNo","SaveLoan","DataService","CommentInfo","SubmitComment",function($rootScope,$scope,$http,$resource,MsgTransmitService,TradeService,TradeStep,MessageShow,UpdateFinance,CheckStep,GoNext,sessionService,AddRemark,HttpHost,SubmitNetsignedNo,SaveLoan,DataService,CommentInfo,SubmitComment){var titleItems=TradeService.titleItems;$rootScope.indexList.headerContent=titleItems.tradeProgress,MsgTransmitService.sendHeader($scope,$rootScope.indexList),TradeService.receiveMsg($scope),$scope.progressObj={editForNode:!1,endChildFinance:!1,editForEvaluateNode:!1,fillNetsignedNo:!1,addComment:!1},$scope.fillNetsignedNo={remindDateBegin:"",contractNo:$scope.tradeObj.tradeNum},$scope.remarkObj={isSendMsg:!1,isEscortCustomer:!1,isShowEscortCustomer:!1,remark:""},$scope.isCheck=!1,$scope.goNext=function(nodeId,isUserCanProcess){isUserCanProcess?checkNode(nodeId):MessageShow.toastMsg(TradeService.titleItems.unOperated)};var checkNode=function(nodeId){MessageShow.showMsg(titleItems.tradeLoad),CheckStep.get({nodeId:nodeId}).$promise.then(function(res){MessageShow.hideMsg(),$scope.isCheck=res.result,!res.result&&res.callbackMethod?($scope.fillNetsignedNo.nodeId=nodeId,$scope.progressObj.fillNetsignedNo=!0):goToNext(nodeId)},function(err){MessageShow.netErrMsg()})},goToNext=function(nodeId,isRunToBusi){MessageShow.showMsg(titleItems.tradeLoad);var sendData={nodeId:nodeId};void 0!=isRunToBusi&&(sendData.isRunToBusi=!1),TradeStep.get(sendData).$promise.then(function(response){MessageShow.hideMsg();var url=response.data.object.redirectToUrl;url?getContractVo(url):realNodeNext(response)},function(err){MessageShow.netErrMsg()})},getContractVo=function(url){var getRealType=$resource(HttpHost.host+url,{},{});MessageShow.showMsg(titleItems.tradeLoad),getRealType.get({}).$promise.then(function(res){MessageShow.hideMsg(),realNodeNext(res)},function(err){MessageShow.netErrMsg()})},realNodeNext=function(response){var type=response.data.object&&response.data.object.nodePageKind||"";switch(type){case"editForNode":$scope.progressObj.editForNode=!0,$scope.remarkObj=response.data.object.pageData;break;case"endChildFinance":$scope.progressObj.endChildFinance=!0,$scope.progressObj.contractVosComByProc=response.data.object.pageData.contractVosComByProc;break;case"editForEvaluateNode":$scope.progressObj.editForEvaluateNode=!0,$scope.progressObj.busiData=response.data.object.pageData.busiData,$scope.progressObj.busiData.nodeId=response.data.object.pageData.nodeId;break;default:MessageShow.toastMsg(titleItems.unOperated)}};$scope.addNetsignedNo=function(){MessageShow.showMsg(titleItems.tradeLoad);var contractId=sessionService.get("contractId")||"";SubmitNetsignedNo.get({contractId:contractId,netsignedNo:$scope.fillNetsignedNo.remindDateBegin}).$promise.then(function(response){MessageShow.hideMsg(),"0000"==response.status?($scope.progressObj.fillNetsignedNo=!1,goToNext($scope.fillNetsignedNo.nodeId)):MessageShow.toastMsg(response.msg)},function(err){MessageShow.netErrMsg()})},$scope.addPrice=function(fdId,nodeId){var sendData={estimateCo:$scope.progressObj.busiData.estimateCo.value,estimatePrice:$scope.progressObj.busiData.estimatePrice,fdId:$scope.progressObj.busiData.fdId};MessageShow.showMsg(titleItems.isSending),SaveLoan.get({data:sendData}).$promise.then(function(res){res.data&&1==res.data.retCode?(MessageShow.toastMsg(titleItems.sendSuccess),goToNext($scope.progressObj.busiData.nodeId,!1)):MessageShow.toastMsg(titleItems.sendFail)},function(){MessageShow.netErrMsg()}),$scope.progressObj.editForEvaluateNode=!1},$scope.addRemark=function(){MessageShow.showMsg(titleItems.tradeSubmit),AddRemark.get({data:$scope.remarkObj}).$promise.then(function(response){$scope.progressObj.editForNode=!1,response.data&&1==response.data.retCode?(MessageShow.toastMsg(titleItems.sendSuccess),DataService.getData(function(res){$scope.tradeData=res.data.object,TradeService.sendMsg($scope,$scope.tradeData)})):response.data.retMsg?MessageShow.toastMsg(response.data.retMsg):MessageShow.toastMsg(titleItems.sendFail)},function(err){MessageShow.netErrMsg()})},$scope.doUpdateChildEndFinance=function(fdId,contractNo){MessageShow.showMsg(titleItems.tradeSubmit),UpdateFinance.query({financeId:fdId}).$promise.then(function(res){res[2]?(MessageShow.hideMsg(),1==res[2].retCode?(MessageShow.toastMsg(titleItems.operateSuccess),DataService.getData(function(res){$scope.tradeData=res.data.object,TradeService.sendMsg($scope,$scope.tradeData)})):MessageShow.toastMsg(titleItems.operateFail+res[2].retMsg)):MessageShow.toastMsg(res[1])},function(err){MessageShow.netErrMsg()})},$scope.showAddComment=function(procId){var contractId=sessionService.get("contractId")||"";MessageShow.showMsg(titleItems.tradeLoad),CommentInfo.get({procId:procId,contractId:contractId}).$promise.then(function(res){MessageShow.hideMsg();var data=res.data.object&&res.data.object.pageData;$scope.commentObj={procId:data.procId,contractId:data.contractId,remark:data.remark,remarkType:data.remarkType,isSendMsg:data.isSendMsg},$scope.progressObj.addComment=!0},function(err){MessageShow.netErrMsg()})},$scope.addComment=function(){var sendData=$scope.commentObj;MessageShow.showMsg(titleItems.tradeLoad),SubmitComment.get({data:sendData}).$promise.then(function(res){MessageShow.hideMsg(),res.data&&1==res.data.retCode?(MessageShow.toastMsg(res.data.retMsg),$scope.progressObj.addComment=!1):MessageShow.toastMsg(res.data.retMsg)},function(err){MessageShow.netErrMsg()})}}]),angular.module("webapp").directive("myDialog",function(){return{restrict:"EA",scope:{isOpen:"=",title:"@",sureBtn:"@",cancelBtn:"@",sureFn:"&"},template:'<div>\t\t\t\t<div class="dialog" ng-show="isOpen">\t\t\t    <div class="dialog-title">\t\t\t        <h2 class="dialog-txt">{{title}}</h2>\t\t\t        <div class="dialog-close">x</div>\t\t\t    </div>\t\t\t    <div class="dialog-content">\t\t\t        <div ng-transclude></div>\t\t\t    </div>\t\t\t    <div class="dialog-btns">\t\t\t        <button class="dialog-btn" ng-show="sureBtn" ng-click="sureFn();">{{sureBtn}}</button>\t\t\t        <button class="dialog-btn" ng-show="cancelBtn" ng-click="cancel();">{{cancelBtn}}</button>\t\t\t    </div>\t\t\t\t</div>\t\t\t\t<div class="mask" ng-show="isOpen"></div>\t\t\t<div>',replace:!0,transclude:!0,link:function(scope,element,attrs){scope.cancel=function(){scope.isOpen&&(scope.isOpen=!1)}}}});