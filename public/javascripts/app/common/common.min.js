angular.module("webapp.controller",["webapp.service"]).controller("LoginController",["$rootScope","$scope","$state","Login","CookieService","MessageShow","sessionService","MsgTransmitService",function($rootScope,$scope,$state,Login,CookieService,MessageShow,sessionService,MsgTransmitService){$rootScope.indexList.headerContent="登录",$rootScope.indexList.showLogout=!1,$rootScope.indexList.showBackBtn=!1,$scope.user={username:CookieService.get("ec_username")||"",password:CookieService.get("ec_password")||"",userinfo:"",isPassword:!1},$scope.pwdFocus=function(){$scope.user.isPassword=!0},$scope.pwdBlur=function(){$scope.user.isPassword=!1},$scope.loginIn=function(){if(""!=$scope.user.username&&""!=$scope.user.password){MessageShow.showMsg("正在登录中...");var user={username:$scope.user.username,password:$scope.user.password};Login.check(user).$promise.then(function(res){1==res.code?(MessageShow.hideMsg(),CookieService.set("ec_username",$scope.user.username,2592e6),CookieService.set("ec_password",$scope.user.password),sessionService.set("ec_userinfo",res.userinfo),sessionService.set("auth_token",1),$rootScope.return_to_state()):MessageShow.toastMsg(res.mes)},function(err){MessageShow.netErrMsg()})}},MsgTransmitService.sendHeader($scope,$rootScope.indexList)}]).controller("IndexController",["$rootScope","$scope","$state","LoginOut","MsgTransmitService","MessageShow","CookieService",function($rootScope,$scope,$state,LoginOut,MsgTransmitService,MessageShow,CookieService){$rootScope.indexList={navItem:[],headerContent:"",showLogout:!0,showBackBtn:!1,showFooter:!1},$scope.logout=function(){LoginOut.get().$promise.then(function(res){1==res.code&&(CookieService.set("ec_username",CookieService.get("ec_username"),-1),CookieService.set("ec_password",CookieService.get("password"),-1),$state.go("ekp.login"))},function(err){MessageShow.netErrMsg()})},$scope.goBack=function(){$state.go("ekp.list")},MsgTransmitService.initHeader($scope)}]).controller("ListController",["$rootScope","$scope","MsgTransmitService",function($rootScope,$scope,MsgTransmitService){$rootScope.indexList.headerContent="首页",MsgTransmitService.sendHeader($scope,$rootScope.indexList)}]),angular.module("webapp.directive",[]).directive("dyName",[function(){return{require:"ngModel",link:function(scope,elm,iAttrs,ngModelCtr){ngModelCtr.$name=scope.$eval(iAttrs.dyName);var formController=elm.controller("form")||{$addControl:angular.noop};formController.$addControl(ngModelCtr),scope.$on("$destroy",function(){formController.$removeControl(ngModelCtr)})}}}]).directive("dyShow",function(){}).directive("myDialog",function(){return{restrict:"EA",scope:{isOpen:"=",title:"@",sureBtn:"@",cancelBtn:"@",sureFn:"&"},template:'<div>        <div class="dialog" ng-show="isOpen">          <div class="dialog-title">              <h2 class="dialog-txt">{{title}}</h2>              <div class="dialog-close">x</div>          </div>          <div class="dialog-content">              <div ng-transclude></div>          </div>          <div class="dialog-btns">              <button class="dialog-btn" ng-show="sureBtn" ng-click="sureFn();">{{sureBtn}}</button>              <button class="dialog-btn" ng-show="cancelBtn" ng-click="cancel();">{{cancelBtn}}</button>          </div>        </div>        <div class="mask" ng-show="isOpen"></div>      <div>',replace:!0,transclude:!0,link:function(scope,element,attrs){scope.cancel=function(){scope.isOpen&&(scope.isOpen=!1)}}}}),angular.module("webapp.resource",["ngResource"]).factory("Login",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/app/public/action.do?method=loginTest2",{},{check:{method:"post"}})}]).factory("LoginSecond",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/app/public/action.do?method=loginTest2",{},{check:{method:"post"}})}]).factory("LoginOut",["$resource","HttpHost",function($resource,HttpHost){return $resource(HttpHost.host+"/ekp/app/public/action.do?method=loginOut",{},{})}]),angular.module("webapp.service",[]).factory("HttpHost",function(){return{host:"/api/ekp/transfer"}}).factory("MsgTransmitService",function(){return{init:function($scope,emitName,broadcastName){$scope.$on(emitName,function(event,msg){$scope.$broadcast(broadcastName,msg)})},send:function($scope,emitName,msg){$scope.$emit(emitName,msg)},receive:function($scope,broadcastName,callback){$scope.$on(broadcastName,function(event,msg){callback(event,msg)})},initHeader:function($scope){this.init($scope,"TopCtrChange","TopCtrChangeFromParrent")},sendHeader:function($scope,msg){this.send($scope,"TopCtrChange",msg)}}}).factory("CookieService",function(){return{set:function(name,value,msec,domain,path){var msec=msec||288e5,path=path||"/",domain=domain?";domain="+domain:"",exp=new Date;exp.setTime(exp.getTime()+msec),document.cookie=name+"="+encodeURIComponent(value)+("section"==msec?"":";expires="+exp.toGMTString())+domain+";path="+path},get:function(name){var viewCookie;if(document.cookie&&""!=document.cookie)for(var cookies=document.cookie.split(";"),cookieLen=cookies.length,i=0;i<cookieLen;i++){var cookie=cookies[i].replace(/(^\s*)|(\s*$)/g,"");if(cookie.substring(0,name.length+1)==name+"="){viewCookie=decodeURIComponent(cookie.substring(name.length+1));break}}return viewCookie}}}).factory("animateService",["$state","$timeout",function($state,$timeout){return{swipeLeft:"swipe-left",swipeRight:"swipe-right",swipeUp:"swipe-up",goPage:function(url){$timeout(function(){$state.go(url)},50)}}}]).factory("LocalService",function(){return{get:function(key){return localStorage.getItem(key)},set:function(key,val){return localStorage.setItem(key,val)},unset:function(key){return localStorage.removeItem(key)}}}).factory("sessionService",function(){return{get:function(key){return sessionStorage.getItem(key)},set:function(key,val){return sessionStorage.setItem(key,val)},unset:function(key){return sessionStorage.removeItem(key)}}}).factory("ListFilter",function(){return{filter:function(jsonData,conditionKey,conditionValue){var returnData;for(var i in jsonData)jsonData[i][conditionKey]==conditionValue&&(returnData=jsonData[i]);return returnData}}}).factory("MessageShow",["$rootScope","$timeout",function($rootScope,$timeout){return{showMsg:function(msg){$rootScope.hasMessage=!0,$rootScope.messages=msg},hideMsg:function(){$rootScope.hasMessage=!1},toastMsg:function(msg){var that=this;this.showMsg(msg),$timeout(function(){that.hideMsg()},2500)},netErrMsg:function(){this.toastMsg("网络错误，请稍后再试！")}}}]).factory("AuthInterceptor",["$q","$injector",function($q,$injector){var CookieService=$injector.get("CookieService");return{request:function(config){var token=CookieService.get("auth_token")||"";return token&&(config.headers.Authorization=token),config},responseError:function(response){return 401!==response.status&&403!==response.status||(CookieService.set("auth_token",CookieService.get("auth_token"),-1),$injector.get("$state").go("ekp.login")),$q.reject(response)}}}]);